service cloud.firestore {
	match /databases/{database}/documents {
		function hasAccess(orgId) {
			return exists(/databases/$(database)/documents/organisations/$(orgId)/users/$(request.auth.uid));
		}

		function isPublic(orgId) {
			return resource.data.isPublic == true;
		}

		function isAuthed() {
			return request.auth.uid != null;
		}

		match /organisations/{orgId} {
			allow read: if isPublic(orgId) || hasAccess(orgId);
			allow create: if isAuthed();
			// TODO: Allow updates only if done by owner or administrator
			// TODO: Allow deletes only if done by owner.

			match /reports/{repId} {
				allow read: if isPublic(orgId) || hasAccess(orgId);
				allow write: if hasAccess(orgId);
			}

			match /users/{uid} {
				allow read;
				allow write: if hasAccess(orgId);
			}
		}

		match /users/{uid} {
			allow read;
			allow write: if request.auth.uid == uid;

			match /organisations/{orgId} {
				allow read;
			}
		}
	}
}